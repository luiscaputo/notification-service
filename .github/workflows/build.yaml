on:
  workflow_call:
    inputs:
      keyvault_name:
        required: true
        type: string
      environment:
        required: true
        type: string

jobs:
  build:
    name: "Pre Deploy"
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # - name: Azure Login
      #   uses: azure/login@v1
      #   with:
      #     creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create .env file from Azure Key Vault
        shell: bash
        run: |
          echo "KEY_VAULT_NAME=${{ inputs.keyvault_name }}" >> .env
          echo "DATABASE_URL=${{ env.DATABASE_URL }}" >> .env
          echo "EMAIL_SENDER=tripee@tripeeapp.com" >> .env
          echo "PORT=3000" >> .env
          echo "APP_URL=http://localhost:3000" >> .env
          
      - name: Check for .env file
        run: cat .env || echo ".env file not found"

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22'

      - name: Install global tools (Nest CLI)
        run: npm install -g @nestjs/cli

      - name: Install dependencies
        run: npm install --force

      - name: Run Prisma db pull
        run: npx prisma db pull

      - name: Generate Prisma client
        run: npx prisma generate

      - name: Build project
        run: npm run build

      - name: Zip build output
        run: |
          cd dist
          zip -r ../release.zip .

      - name: Upload artifact for deployment
        uses: actions/upload-artifact@v4
        with:
          name: node-app
          path: release.zip