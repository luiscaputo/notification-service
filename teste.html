<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teste de Envio de Notificações</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #fff;
      color: #222;
      min-height: 100vh;
    }
    .logo-tripee {
      display: block;
      margin: 32px auto 16px auto;
      max-width: 180px;
      max-height: 80px;
    }
    .form-section {
      background: #fff;
      border-radius: 12px;
      padding: 32px 28px 24px 28px;
      max-width: 700px;
      margin: 0 auto;
      border: 1px solid #e0e0e0;
    }
    .form-section h2 {
      color: #1e88e5;
      font-weight: 700;
      margin-bottom: 24px;
      text-align: center;
    }
    .form-label { color: #444; font-weight: 500; }
    .form-control, .form-select {
      background: #fff;
      color: #222;
      border: 1.5px solid #bdbdbd;
      border-radius: 7px;
      transition: border 0.2s;
    }
    .form-control:focus, .form-select:focus {
      border-color: #1e88e5;
      box-shadow: none;
    }
    .btn-primary {
      background: #1e88e5;
      border: none;
      font-weight: 600;
      border-radius: 7px;
      transition: background 0.2s;
    }
    .btn-primary:hover {
      background: #1565c0;
    }
    .form-text { color: #888 !important; }
    .result {
      margin-top: 20px;
      min-height: 32px;
      text-align: center;
      font-size: 1.1rem;
      transition: color 0.3s;
    }
    @media (min-width: 768px) {
      .row-cols-md-2 > .col-md-6 {
        padding-right: 16px;
        padding-left: 16px;
      }
    }
  </style>
</head>
<body>
  <img src="/logo-tripee.png" alt="Logo Tripee" class="logo-tripee" onerror="this.style.display='none'">
  <div class="form-section">
    <h2>Envio de Notificações</h2>
    <form id="notificationForm" autocomplete="off">
      <div class="row row-cols-1 row-cols-md-2 g-3">
        <div class="col-md-6">
          <label for="application" class="form-label">Aplicação</label>
          <select class="form-select" id="application" required></select>
        </div>
        <div class="col-md-6">
          <label for="type" class="form-label">Tipo de Notificação</label>
          <select class="form-select" id="type" required>
            <option value="EMAIL">Email</option>
            <option value="SMS">SMS</option>
            <option value="PUSH">Push</option>
            <option value="DISCORD">Discord</option>
            <option value="SLACK">Slack</option>
            <option value="IN_APP">In App</option>
          </select>
        </div>
        <div class="col-md-6">
          <label for="title" class="form-label">Título</label>
          <input type="text" class="form-control" id="title" required placeholder="Título da notificação">
        </div>
        <div class="col-md-6">
          <label for="receipts" class="form-label">Destinatário(s)</label>
          <input type="text" class="form-control" id="receipts" placeholder="Ex: email@dominio.com, +5511999999999" required>
          <div class="form-text">Separe múltiplos destinatários por vírgula.</div>
        </div>
        <div class="col-12">
          <label for="body" class="form-label">Conteúdo</label>
          <textarea class="form-control" id="body" rows="3" required placeholder="Conteúdo da notificação"></textarea>
        </div>
        <div class="col-md-6">
          <label for="scheduledAt" class="form-label">Data de Agendamento (opcional)</label>
          <input type="datetime-local" class="form-control" id="scheduledAt">
        </div>
      </div>
      <button type="submit" class="btn btn-primary w-100 mt-4">Enviar Notificação</button>
    </form>
    <div class="result" id="result"></div>
  </div>
  <script>
    async function fetchApplications() {
      try {
        const res = await fetch('/application?perPage=100');
        const data = await res.json();
        const select = document.getElementById('application');
        if (data && data.data) {
          data.data.forEach(app => {
            const opt = document.createElement('option');
            opt.value = app.api_key;
            opt.textContent = app.name;
            select.appendChild(opt);
          });
        }
      } catch (e) {
        alert('Erro ao buscar aplicações!');
      }
    }
    fetchApplications();
    document.getElementById('notificationForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const apiKey = document.getElementById('application').value;
      const type = document.getElementById('type').value;
      const title = document.getElementById('title').value;
      const body = document.getElementById('body').value;
      const receiptsRaw = document.getElementById('receipts').value;
      const scheduledAt = document.getElementById('scheduledAt').value;
      const receipts = receiptsRaw.split(',').map(r => r.trim()).filter(Boolean);
      const payload = { type, title, body, receipts };
      if (scheduledAt) payload.scheduledAt = new Date(scheduledAt).toISOString();
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = '<span class="text-info">Enviando...</span>';
      try {
        const res = await fetch('/notification', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': apiKey
          },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (res.ok) {
          resultDiv.innerHTML = '<span class="text-success">Notificação enviada com sucesso!</span>';
        } else {
          resultDiv.innerHTML = '<span class="text-danger">Erro: ' + (data.message || JSON.stringify(data)) + '</span>';
        }
      } catch (err) {
        resultDiv.innerHTML = '<span class="text-danger">Erro ao enviar: ' + err.message + '</span>';
      }
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

